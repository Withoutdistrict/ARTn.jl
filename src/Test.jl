using LinearAlgebra
# using IterativeSolvers
using LinearMaps
# using KrylovKit # good

include("Calculator.jl")
include("Lanczos.jl")


function A(z)
    del_lanczos = 0.01
    xₜ₊₁ = xᵢ + z * del_lanczos
    e, fₜ₊₁ = calcforces(xₜ₊₁)
    return -(fₜ₊₁ - fᵢ) / del_lanczos
end


# eigenvalue
# -0.56802507579958084
# Cell parameters
# 16.291494000000000
# Current energy
# -926.68429882152702

# x
xᵢ =
    [16.28537254494995 16.30003311394788 16.28930916099546
        16.28431550637134 2.72994124602239 2.71914230044141
        2.71002414920140 16.30370082236323 2.71419468255805
        2.71640040093173 2.73317554513273 16.28605530609325
        1.35407804452596 1.37410778486367 1.35643068236047
        5.42317040339703 16.29874177545963 16.27566065577089
        5.42689304315863 2.74627314385469 2.72373666691418
        8.12062704854520 16.29887405107287 2.73370719456073
        8.11703353159700 2.75380356441203 16.26441777200218
        6.77701444020994 1.37765333035741 1.35341771142553
        10.83814208938377 16.30810121153412 16.30099856355861
        10.83966869975042 2.72636981005127 2.72150131412984
        12.20635578399602 1.37155293918068 1.36593002213296
        13.55937814302832 16.29825002395835 2.72122116764878
        13.56536104712696 2.72774165704540 16.29327235378270
        16.29757079846874 5.44250957402701 16.28928815530070
        2.72240983777735 5.45318014639155 2.72162844489010
        4.07879034442416 4.10217647384150 1.34563475831587
        5.43381245183944 5.46408921300554 -0.03429740903613
        9.48090944282221 4.08374375569618 1.36397017093643
        8.12785414997223 5.45033762036752 2.72731906447158
        10.84227660821552 5.43274542467503 0.00881192016003
        14.92975431479943 4.08822781061751 1.36095748866481
        13.56373315181633 5.44074330639958 2.72443279659269
        16.30177155814523 8.15377124343136 2.72591252237465
        2.74683646002926 8.14771753333168 16.24865432052362
        1.37493893918521 6.80776211089337 1.34663722910738
        4.06811268796921 9.50896831133360 1.35342627761721
        5.42357652080936 8.16176539149229 2.72162592653155
        8.13458824682627 8.16029626898369 16.29691418752146
        6.78170484255345 6.80622726499577 1.35755052577465
        9.49341246583388 9.51564191930391 1.36925842228342
        10.83752248940226 8.15570384261285 2.73189132261733
        12.20443883243435 6.79634995425300 1.37248677695547
        13.59473055086454 8.14267095234557 16.32590987206548
        14.94303103966136 9.51734899663963 1.37977098720447
        16.30760741894749 10.85727218143979 16.28638116658591
        2.71631499594697 10.86690460005208 2.72261238781598
        1.36114242232278 12.22577851475847 1.36050111002968
        5.41542721538836 10.85995979309735 -0.00896031592126
        8.12713437130808 10.86759091565545 2.72464500070883
        6.77092168027767 12.22137836440132 1.36116165782661
        10.84852358410541 10.87859088608697 0.01881957522677
        12.20727117788354 12.23158334196788 1.37903194459787
        13.55074434455754 10.86016089238722 2.73576620189809
        16.28040819881389 13.57966429860724 2.71584350135155
        2.71853013885977 13.57440999286983 16.27710341242754
        4.06886015495218 14.94166340053656 1.35430572067345
        5.41999760553235 13.58154351527216 2.72403261790230
        8.11361406445931 13.60553553738392 16.31172814343012
        9.48648450583386 14.94925617995677 1.37763086823623
        10.83225971593165 13.57519158028542 2.73789220621520
        13.56539560840029 13.58207704699507 0.00589090859672
        14.92633888892266 14.94589796320164 1.36342239555174
        16.27858882491596 16.30301377096655 5.43667573025591
        2.71769674616332 2.74347477989214 5.44226542331864
        4.06864836091940 1.37602932659256 4.07741653902888
        5.42257660835271 16.29807858835421 5.43536180636684
        9.48172589321265 1.37430323582605 4.09040295483643
        8.12933358001055 2.74925696100507 5.45187542052717
        10.83282661276911 16.29182451734891 5.44283282901329
        14.92201275665007 1.37078667040422 4.07822932618326
        13.56048653145777 2.72682500975547 5.43927541099940
        1.35634634250047 4.09272245855334 4.07769281116301
        16.29414280526427 5.45171986243011 5.44410476643950
        5.44840190697500 5.51569560317111 5.50323877152092
        6.76715317349493 4.11936117266829 4.10985152502380
        12.20000892580919 4.08589438428908 4.08573886764739
        10.83523663161422 5.44725023240085 5.44718712425622
        1.37452080481845 9.50548073635355 4.09533456157066
        2.75102649864948 8.17330962469942 5.47546527282287
        4.07972735684246 6.81104955768526 4.09732562558263
        6.77687895081125 9.51650569868109 4.09161561345796
        9.47786024445329 6.80832049770523 4.10126774623492
        8.11860936121407 8.17087848491442 5.47288056462892
        12.17367999924562 9.52035377767222 4.11331731546514
        14.92609780312382 6.80211882217109 4.08458818005933
        13.54632064575632 8.15115124013950 5.44405916910017
        16.28605107236354 10.86731740579006 5.42765328334610
        4.07319530557041 12.22545715443942 4.09051496033434
        5.44114515161506 10.88180203655598 5.46270405143839
        9.47760480007872 12.21058573958633 4.10879003572624
        10.77782364997366 10.83867404136211 5.50854937351094
        14.91878767954682 12.22664045914749 4.08100795414306
        1.34698780159925 14.94734180498558 4.07341577002616
        2.70570663424909 13.58741705952195 5.42954088174756
        6.78593197921908 14.91286670569734 4.10801657984029
        8.10916100138324 13.51812309317627 5.50192811853565
        12.19926003237297 14.94142094537559 4.08407154728613
        13.54698510171248 13.57520209404741 5.44208454329867
        16.29751152720421 2.74258230369570 8.15547196164977
        2.71316993274864 16.29937960675666 8.14701560036452
        1.35437743290559 1.37455402336135 6.79272593969882
        4.06988156636937 1.37943778894745 9.50343936390413
        5.42712303364754 2.74877247181555 8.15544893884991
        8.12557906638073 16.29971657708105 8.14978124650508
        6.77414813862060 1.37572113666238 6.79716706417552
        9.48830733522940 1.36904719796825 9.50620970543083
        10.83253214328224 2.74066881767605 8.14987385082387
        12.19390105664944 1.37096002384590 6.79600337925568
        13.54862052987987 16.29603750628869 8.15202142690070
        14.92834680116253 1.37042222269817 9.50137346251651
        1.38990102184872 4.11919699687945 9.49669798375140
        2.78327713086123 5.51558682274090 8.18091662082202
        4.07900636439276 4.11697433676068 6.80548642016042
        6.79622092307599 4.12310392438145 9.50959840862265
        9.46366805646364 4.13167397618091 6.83047761616159
        8.12670954803905 5.52490316179492 8.19867963854440
        12.19747128614078 4.09713901010421 9.51355507849572
        14.92669364654483 4.08955114692821 6.79522229857475
        13.55780091827130 5.44764487975531 8.14982857552556
        16.28900494330020 8.15773312236120 8.14693298696399
        1.37679564152697 6.80815063868344 6.80601616641752
        1.35847400174163 9.51713007777366 9.50079878004581
        4.20627989839771 6.94229431500546 9.48888009593391
        4.11951489588825 9.54401893021270 6.84963814960680
        5.65845990955899 8.59538290249439 8.40418157234448
        6.75029296411731 6.94487136319229 6.92847578756249
        9.44968732339544 6.89884199248100 9.69638708011522
        9.37753277903228 9.50988285020311 6.94088154080469
        10.81132267347860 8.14799353044986 8.21553549146977
        12.18492064393508 6.80627007942102 6.81316704221536
        12.26841770895546 9.52303342590175 9.49806806450438
        14.93579975788933 6.79726676185914 9.50407801337152
        14.93476402653448 9.50545328928074 6.77922947299276
        2.69860904167769 10.88218010978533 8.13696006007980
        1.34603132071687 12.23419296715253 6.78280405523158
        4.10773223829508 12.18157832597469 9.47648427196611
        7.80136833088562 10.44133448162252 8.64453721703040
        6.82389972703082 12.09487959053089 6.94377823707753
        9.41696854423600 12.13690428604295 9.52694433122365
        12.18277805138876 12.21628274066730 6.80228717300402
        13.58713630603692 10.87573826601005 8.12556357976493
        14.93744432044789 12.23512128711447 9.50261269245316
        16.28495002104280 13.58827587454772 8.14613432814669
        1.37040979343359 14.92968197645956 9.50968442224613
        4.07136056028664 14.93366262967176 6.79114129214513
        5.43292941144683 13.56738192322291 8.14235939460053
        6.77752867403125 14.93441633924902 9.50669928993649
        9.47424705859524 14.92428285270140 6.80245673203596
        10.79039011067486 13.53719160953940 8.16266528709525
        12.18370426439104 14.92445473732768 9.49641832325467
        14.91569939563905 14.94322825691129 6.79235384487532
        16.30497611079253 16.31065407630733 10.85549061652893
        2.74667092956547 2.76973527864377 10.86494481378179
        1.37628507801177 1.38772364092001 12.21023899959934
        5.42047980161659 16.30225901450128 10.85459197818772
        8.13655922218452 2.73935526479927 10.85700479708285
        6.78053976846567 1.37497399263168 12.21147978092846
        10.84064767359054 16.29480151636610 10.86010635904928
        12.20548424081878 1.36821189681349 12.21865847497988
        13.56101863593513 2.72951875964447 10.85618239945227
        16.29857874103243 5.44849492695823 10.85805140984674
        4.15100128241585 4.17559490418609 12.17256818550417
        5.58227422868777 5.61215359422540 10.85857325604797
        9.50376645797539 4.09384643487950 12.22122188468182
        10.86618104651054 5.44956693459614 10.89568697852583
        14.93762018300202 4.08194378835865 12.21228387305660
        2.74369304519583 8.17407862570982 10.84532561291951
        1.37866804073237 6.81053235940040 12.20625886319310
        4.20586543356677 9.53031185455304 12.08409239473323
        8.90283376793239 9.04901204034522 10.67410330746059
        7.23928969883537 7.15347105043139 11.85482401939461
        9.91406633286281 9.89387772766057 12.64613979311282
        12.25443130576972 6.79798455647019 12.23259969359454
        13.58757933937243 8.15723560478989 10.86498206196698
        14.94606829201301 9.51798531596197 12.22755219712175
        16.28944242122219 10.87053062840029 10.85701182223836
        1.37628599807740 12.21423328165831 12.21132802076748
        5.63366483380849 10.65074825066473 10.44475603574847
        6.75388057160959 12.12114124430844 12.09126144587456
        11.09422845190144 11.07155508042275 10.78615626808276
        12.30004096515212 12.31511233413639 12.28511298097084
        2.74181798409450 13.54942004607410 10.84604115558749
        4.07432524879779 14.92827789174776 12.20517984188396
        8.12398123328640 13.56744984495631 10.85893396160398
        9.48704008655513 14.93667669297763 12.22123572910413
        14.95656418945526 14.96782255372726 12.22774033504347
        13.59840122472332 13.62218474947049 10.85496092601867
        16.29502236339508 2.73117012119502 13.57211550170318
        2.71986577636291 16.29990965588235 13.56582581695424
        4.07742025160092 1.38377076071240 14.91813173044210
        5.43331027627615 2.75975247608759 13.55215790091516
        8.12597588520974 16.29804052937255 13.56885884034479
        9.48279009108826 1.37096417777931 14.93469549396345
        10.84409915887164 2.72808600360661 13.57789825583807
        13.56853709758574 16.30701655557893 13.57639356950600
        14.93275973383366 1.37481796904682 14.93519700319207
        1.37423793966283 4.09739955457074 14.92098497803056
        2.74524253723839 5.46128641251035 13.55412087489033
        6.80905068227867 4.15514984983685 14.86300183317763
        8.15532047310291 5.56336302227903 13.45879669139992
        12.21044547307026 4.08481119930773 14.93753730271146
        13.58327474732811 5.43287513187482 13.57994491041805
        16.30129820588537 8.15581486751768 13.56854437901787
        1.39256413908961 9.51930721590811 14.90284934628933
        4.15470454051238 6.84596863950119 14.83930598104908
        5.59393850881622 8.15606961788049 13.40278693157176
        6.79001309995896 9.50455851490647 14.92571555669220
        9.49718671935713 6.79794818178129 14.94837509734505
        10.94768995350003 8.14015734855255 13.67063575288078
        12.26311290954725 9.52486910195237 14.99427446748906
        14.94252856868275 6.79936175948344 14.93810601891112
        2.78087148148326 10.83702170612977 13.50400872565882
        4.07990785740154 12.21319538978709 14.90371993552526
        8.11699032662414 10.95357072053787 13.63649867443884
        9.49863092416383 12.27113578400431 14.97721960709660
        13.59721179927568 10.87271773971159 13.60103178909821
        14.95433649348448 12.23552659232065 14.95293046007778
        16.30163836623391 13.57806167144590 13.56972399610806
        1.36140780438692 14.94527097336858 14.93147591293794
        5.43827649510118 13.52895149642789 13.50551342718791
        6.76380877164315 14.91868645806577 14.90413878863546
        10.84724223246129 13.61321190818873 13.59907066418843
        12.21669962009111 14.96388040884842 14.95446107209779]'
# x
xᵢ = Matrix{Float64}(xᵢ)
# x
# xᵢ += rand(Float64, size(xᵢ))*0.35
e, fᵢ = calcforces(xᵢ)

# q = lanczos(xᵢ, fᵢ, fᵢ, true)
# q = lanczos(xᵢ, fᵢ, q, false)
# q = lanczos(xᵢ, fᵢ, q, false)
# @time q = lanczos(xᵢ, fᵢ, q, false)


δ = 0
# LanczosIterator(A, xᵢ, ModifiedGramSchmidt())
# xᵢ += rand(Float64, size(xᵢ))*0.3
values, vectors, state = artn_lanczos(A, rand(Float64, size(xᵢ)), 2, Lanczos(; krylovdim=40, ϵ=0.01, eager=true))
println(values)
δ += abs(values[1])

xᵢ += rand(Float64, size(xᵢ))*0.3
e, fᵢ = calcforces(xᵢ)
values, vectors, state = artn_lanczos(A, state.V, 2, Lanczos(; krylovdim=40, ϵ=0.01, eager=true), state=state)
println(values)
δ += abs(values[1])
println("\n\n\n")


values, vectors, state = artn_lanczos(A, vectors[1], 6, Lanczos(; krylovdim=40, ϵ=0.0001, eager=true))
println(values)
# δ += abs(values[1])

# values, vectors, state = artn_lanczos(A, vectors[1], 1, Lanczos(; ϵ=0.01, eager=true))
# # println(values)
# δ += abs(values[1])
# values, vectors, state = artn_lanczos(A, vectors[1], 1, Lanczos(; ϵ=0.01, eager=true))
# # println(values)
# δ += abs(values[1])
# @time values, vectors, state = artn_lanczos(A, vectors[1], 1, Lanczos(; ϵ=0.01, eager=true))
# # println(values)
# δ += abs(values[1])

# δ /= 2
# δ -= 0.344102816747449
# if δ < 0.001
#     println("Test success =================== δ=$δ ==================== Test success")
# else
#     println("Test failed  =================== δ=$δ===================== Test failed")
# end
# println(values[1])












# [-0.33600880695099467, 0.0009734358027875811]
# ConvergenceInfo: 2 converged values after 2 iterations and 34 applications of the linear map;
# norms of residuals are given by (0.00790536479802783, 0.0008878845109276174).
# vals, vecs, info = eigsolve(A, xᵢ, 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)
# vals, vecs, info = eigsolve(A, vecs[1], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)
# vals, vecs, info = eigsolve(A, vecs[1], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)
# vals, vecs, info = eigsolve(A, vecs[1], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)

# println(size(vecs[end]))
# println(typeof(vecs[end]))

# vals, vecs, info = eigsolve(A, vecs[end], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)
# vals, vecs, info = eigsolve(A, vecs[end], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)
# vals, vecs, info = eigsolve(A, vecs[end], 2, :SR; tol=0.01, eager=true, issymmetric=true, ishermitian=true)
# println(vals)
# println(info)











